<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" type="text/css" href="../../css/modal.css">
</head>
<body>
	<div class="container">
		<h2>Lista de Usuários</h2>
		<table id="example" class="display" cellspacing="0" width="100%">
		</table>
		<div class="form-group">
			<a href="#openModalCreate"><span class="icon fa-plus"></span></a> <a
				href="#openModalEdit"><span id="edit" class="icon fa-pencil-square-o"></span></a>
			<a href="#"><span id="remover" class="icon fa-trash-o"></span></a>
		</div>
	</div>
	<div id="openModalCreate" class="modalDialog">
		<div class="background">
			<a href="#close" title="Close" class="close">X</a>
			<h2 class="text">Cadastrar Usuário</h2>
			<form id="form_modal" action="javascript:verifica();">
				<p id="form-group-modal">
					<label class="text_lab" for="inputUser">Usuário: </label> 
					<input class="formulario" type="text" id="nome" name="nome" placeholder="Nome de Usuário" required>
				</p>
				<p id="form-group-modal">
					<label class="text_lab" for="inputEmail">E-mail: </label> 
					<input class="formulario" type="email" id="email" name="email" required>
				</p>
				<p id="form-group-modal">
					<label class="text_lab" for="inputPassword">Senha: </label> 
					<input class="formulario" type="password" id="password" name="password" required>
				</p>
				<p id="form-group-modal">
					<input type="checkbox" id="admin" name="admin" value="1"> 
					<label	for="admin">Administrador</label>
				</p>
				<button id="submit">Cadastrar</button>
			</form>
		</div>
	</div>
	<div id="openModalEdit" class="modalDialog">
		<div class="background">
			<a href="#close" title="Close" class="close">X</a>
			<h2 class="text">Editar Usuário</h2>
			<form id="form_modal" action="javascript:verifica();">
				<p id="form-group-modal">
					<label class="text_lab" for="inputUser">Usuário: </label> 
					<input class="formulario" type="text" id="nome" name="nome" required>
				</p>
				<p id="form-group-modal">
					<label class="text_lab" for="inputEmail">E-mail: </label> 
					<input class="formulario" type="email" id="email" name="email" required>
				</p>
				<p id="form-group-modal">
					<input type="checkbox" id="admin" name="admin" value="1"> 
					<label	for="admin">Administrador</label>
				</p>
				<button id="submit">Editar</button>
			</form>
		</div>
	</div>
	<script>
$(document).ready(function(){
	$.getJSON( "http://localhost:8080/VirtualQueue/VQ/user/list", function( data ) {
		  var userlist = data;
		  var table = $('#example').DataTable( {
			    scrollY:        '50vh',
		        scrollCollapse: true,
		        paging:         false,
		        "language": {"emptyTable": "Nenhum Usuário Cadastrado"},
			    "aaData": userlist,
			    "aoColumns": [
			      { "sTitle": "Código",   "mData": "id" },
			      { "sTitle": "Nome",  "mData": "nome" },
			      { "sTitle": "Email", "mData": "email" },
			      { "sTitle": "Privilégio",  "mData": "privilegio" }
			    ]
			  } );
		   
		    $('#example tbody').on( 'click', 'tr', function () {
		        $(this).toggleClass('selected');
		    } );
		    
		    $('#edit').click(function(){
	  			var data = table.rows('.selected').data();
	  			console.log(data[0]);
		  		$("#openModalEdit #form_modal input#nome").val(data[0].nome);
		  		$("#openModalEdit #form_modal input#email").val(data[0].email);
		  		$("#openModalEdit #form_modal input#admin").val();
		  	});
		    
		    $('#remover').click( function () {
  		    	var data = table.rows('.selected').data();
  				if (data.length == 0) {
  					swal("","Selecione ao menos um usuário...")
  				} else {
  					swal({   
  						title: "",   
  						text: "Deseja realmente deletar este usuário?\n (esta ação não poderá ser desfeita)",   
  						type: "",   
  						showCancelButton: true,
  						confirmButtonColor: "#8ebebc",   
  						confirmButtonText: "Sim",   
  						cancelButtonText: "Não",   
  						closeOnConfirm: true,   
  						closeOnCancel: true }, 
  						function(isConfirm){   
  							if (isConfirm) {
  									for (var int = 0; int < data.length; int++) {
  										$.ajax({
  										     type: "POST",
  										     url: "http://localhost:8080/VirtualQueue/VQ/user/deleta",
  										     data: data[int].email,
  										     contentType: "application/json; charset=utf-8",
  										     dataType: "json",
  										     processData: true,
  										     success: function (vdata, status, jqXHR) {
  										    	 $("#conteudo").load("users.html");
  										     },
  										     error: function (xhr) {
  										         alert("Erro" + xhr.responseText);
  										     }
  										});
  									}
  					}});
  				}
  		    });	
	});
}); 
function verifica(){
	user = new Object();
	user.nome = document.getElementById("nome").value;
    user.email = document.getElementById("email").value;
    user.password = document.getElementById("password").value;
    var admin = document.getElementById("admin").checked;
        if (admin == true) {
			user.privilegio = "Administrador";
		} else {
			user.privilegio = "Usuario";
		}
    		$.ajax({
			     type: "POST",
			     url: "http://localhost:8080/VirtualQueue/VQ/user/createform",
			     data: JSON.stringify(user),
			     contentType: "application/json; charset=utf-8",
			     dataType: "json",
			     processData: true,
			     success: function (vdata, status, jqXHR) {
			    	 if (vdata == true) {
			    		 $("#conteudo").load("users2.html");
					 }else {
						swal("","Este email já está sendo usado")
					 }
			     },
			     error: function (xhr) {
			         alert("Erro" + xhr.responseText);
			     }
			});
    }
</script>
</body>
</html>