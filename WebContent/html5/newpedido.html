<!DOCTYPE html>
<html lang="pt-br">
<head>
<title>Virtual Queue</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<script src="../js/jquery/jquery-2.1.4.min.js" type="text/javascript"></script>
<script src="../js/jquery/jquery.serializejson.js"	type="text/javascript"></script>
</head>
<body onload="updateClock()">
	<div id="header"></div>
	<div class="container">
		<h2>Pedido</h2><br>
		<div class="form-group">
			<div class="form-group" id="combo"></div>
		</div>
		<div class="form-group">
			<div class="col-sm-offset">
				<input type="submit" class="btn btn-default" value="Adicionar" onclick="addProduto();total_pedido();" style="margin-top: 10px;">
			</div>
		</div>
		<div class="">
			<table id="myTable" border="1" class="table stripped">
				<tr style="background-color:#F8F8F8;">
					<th>Código</th>
					<th>Nome</th>
					<th>Preço</th>
					<th>Remover</th>
				</tr>
				<tr>
					<td></td>
					<td></td>
					<td align="right"><b>Total: </b></td>
					<td id="total"><b>R$0,00</b></td>
				</tr>
			</table>
		</div>
		<div class="form-group" style="float:right;">
			<h4><label class="col-rm-10" id="senha">Senha: </label></h4>
			<h4><label class="col-rm-10" id="clock">Data: </label></h4>
		</div>
		<div class="form-group">
			<div class="col-sm-offset">
				<input type="submit" class="btn btn-default" value="Finalizar Pedido" onclick="fechar_pedido()"	style="margin-top: 10px;">
			</div>
		</div>
			<input type="submit" class="btn btn-default" value="Ver Dados Pedido" onclick="verifica_pedido()"	style="margin-top: 10px;">
		</div>
		<div id="footer"></div>
	<script>
		//Cria arrays de pedido e produtos
		var pedido = [];
		var produtos = [];
		var total = 0;
		
		//Chama as funções
		lista();
		populaCombo();
		gerar_senha();
				
		function lista() {
			var list = "http://localhost:8080/VirtualQueue/VQ/produto/list";
			$.ajax({
				type : 'GET',
				url : list,
				crossDomain : true,
				dataType : "json",
				success : carregaProduto, // função de retorno dos produtos
				error : function(xhr, status, error) {
					var err = eval("(" + xhr.responseText + ")");
					alert(err.Message);
				}
			});
		}

		function populaCombo() {
			//Popula a combobox com produtos do banco de dados
			$(document).ready(function() {
					$.ajax({
						dataType : 'json',
						url : "http://localhost:8080/VirtualQueue/VQ/produto/list",
						data : produtos, //array produtos
						success : function(data) {
							var q = '<select name="idCombox2" id="idCombox2" class="form-control"> <option value="-1"><-- Selecione um Produto --></option>';
							for (i = 0; i < data.length; i++) {
								q += '<option value=' + i + '>'
										+ data[i].nome
										+ '</option>';
							}
							q += '</select>';
							$('#combo').html(q);
							}
					});
			});
		}
		
		function carregaProduto(data) {
			produtos = data;
			// gerar Combo dos Produtos
		}

		function addProduto() {
			//Adiciona um produto da combobox na tabela de pedido
			var selecionado = document.getElementById("idCombox2").value;
			if (selecionado == -1) {
				alert("Por favor, selecione um produto...");
			} else {
				var table = document.getElementById("myTable");
				var row = table.insertRow(1);
				var cell1 = row.insertCell(0);
				var cell2 = row.insertCell(1);
				var cell3 = row.insertCell(2);
				var cell4 = row.insertCell(3);
				
				cell1.innerHTML = produtos[selecionado].cod_produto;
				cell2.innerHTML = produtos[selecionado].nome;
				cell3.innerHTML = "R$ "+produtos[selecionado].preco+",00";
				cell4.innerHTML = "<a href='#' class='delete' value='"+produtos[selecionado].cod_produto+"'><img src='../img/x.png' onclick='removeProduto("+selecionado+");"+total_pedido(selecionado)+";' height='15' width='15'></a>";
				pedido[selecionado] = produtos[selecionado];
			}
		}
		
		function removeProduto(remove){
			    $("#myTable .delete").on("click",function() {
			        var td = $(this).parent();
			        var tr = td.parent();
			        tr.remove();
			    });
			    /* pedido[remove] = null; */
			    delete (pedido[remove]);
			    total = total - produtos[remove].preco;
			    $("#total").html("R$ "+total);
		}
		
		function total_pedido(preco){
			//Realiza a soma dos pedidos da tabela e atualiza o valor total do pedido
			total += produtos[preco].preco;
			$("#total").html("R$ "+total);
		}
		
		function fechar_pedido() {
			//Finaliza e envia o Pedido
			$.ajax({
			     type: "POST",
			     url: "http://localhost:8080/VirtualQueue/VQ/pedido/pedidocreate",
			     data: JSON.stringify(pedido),
			     contentType: "application/json; charset=utf-8",
			     dataType: "json",
			     processData: true,
			     success: function (vdata, status, jqXHR) {
			         alert("Pedido Enviado com Sucesso");
			     },
			     error: function (xhr) {
			         alert("Erro" + xhr.responseText);
			     }
			 });
			 
			//alert(JSON.stringify(pedido));
		}
		
				function gerar_senha(){
			//Gera uma senha randomica automaticamente
			var senha = Math.floor((Math.random() * 100)+1);
			$("#senha").html("Senha: "+senha);
		}
		
		function updateClock(){
		 	var currentTime = new Date ( );
		  	var currentHours = currentTime.getHours ( );
		  	var currentMinutes = currentTime.getMinutes ( );
		  	var currentSeconds = currentTime.getSeconds ( );
		  	// Pad the minutes and seconds with leading zeros, if required
		  	currentMinutes = ( currentMinutes < 10 ? "0" : "" ) + currentMinutes;
		  	currentSeconds = ( currentSeconds < 10 ? "0" : "" ) + currentSeconds;
		  	// Compose the string for display
		  	var currentTimeString = currentHours + ":" + currentMinutes + ":" + currentSeconds;
		$("#clock").html(currentTimeString);
	}
	$(document).ready(function(){
	   setInterval('updateClock()', 1000);
	});
	
	function verifica_pedido(){
		//Botão para checar o json que será mandado ao PedidoWebService
		alert(JSON.stringify(pedido));
	}
	
	$(document).ready(function(){
		$("#header").load('menu.html'); //Inclui o menu no topo da página
		$("#footer").load('footer.html'); //Inclui o footer
	});
	
	</script>
</body>
</html>
